<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>简单地图</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <style type="text/css">
        html,
        body {
            width: 100%;
            height: 100%;
        }

        * {
            margin: 0px;
            padding: 0px;
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 12px/16px Verdana, Helvetica, Arial, sans-serif;
        }

        p {
            width: 603px;
            padding-top: 3px;
            overflow: hidden;
        }

        .btn {
            width: 142px;
        }

        #container {
            width: 100%;
            height: 100%;
        }
    </style>
    <script charset="utf-8" src="https://map.qq.com/api/js?v=2.exp&key=2RHBZ-FSF66-SHQS6-M4ANO-7NPKE-QIFP5"></script>

</head>

<body>
    <!--   定义地图显示容器   -->
    <div id="container"></div>

    <script>
        ; (function () {

            var map // 地图实例
            var typhoonCount    // 地图上台风数量的计数器
            var typhoonList     // 台风数据数组
            var typhoonListSnd
            var typhoonListTrd
            var markerArray     // 台风路径点数组
            var markerCluster   // 台风路径集合
            var markerEventArray     // 台风路径点的点击事件数组
            var polylineArray   // 路径折线数组
            var infoWindow      // 台风信息气泡


            window.onload = function () {

                //直接加载地图


                //初始化地图函数  自定义函数名init
                function init() {

                    //定义map变量 调用 qq.maps.Map() 构造函数   获取地图显示容器
                    map = new qq.maps.Map(document.getElementById('container'), {
                        center: new qq.maps.LatLng(30, 123),    // 地图的中心地理坐标。
                        zoom: 4                                 // 地图的缩放级数。
                    })


                    // 初始化公共变量
                    typhoonCount = 0
                    markerArray = new qq.maps.MVCArray()
                    markerCluster = new qq.maps.MarkerCluster({
                        map: map,
                        minimumClusterSize: 99, //默认2
                        markers: markerArray,
                        zoomOnClick: true, //默认为true
                        gridSize: 30, //默认60
                        averageCenter: true, //默认false
                        maxZoom: 7, //默认18
                    })
                    typhoonList = []
                    typhoonListSnd = []
                    typhoonListTrd = []
                    markerEventArray = []
                    polylineArray = []
                    infoWindow = new qq.maps.InfoWindow({
                        map: map,
                        zIndex: 99
                    })
                }

                //调用初始化函数地图
                init()

                startupRequest()

                // setTimeout(function () {
                //     console.log('suprise!')
                //     // console.log('typhoonList.length = ' + typhoonList.length)
                //     // console.log('markerArray.length = ' + markerArray.getLength())
                //     clearMap()
                // }, 10000)

            } // end-window.onloda()

            // 向服务器请求数据
            var requestData = function (url, data) {
                var xmlhttp = new XMLHttpRequest()
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState === XMLHttpRequest.DONE) {   // XMLHttpRequest.DONE === 4
                        if (xmlhttp.status === 200) {
                            // console.log(xmlhttp.responseText)
                            var parser = new DOMParser()
                            var xmldoc = parser.parseFromString(xmlhttp.responseText, 'text/xml')
                            // console.log(JSON.parse(xmldoc.getElementsByTagName('string')[0].innerHTML))
                            console.log(xmldoc.getElementsByTagName('string')[0].innerHTML)
                        } else if (xmlhttp.status === 400) {
                            console.log('error 400')
                            alert('There was an error 400')
                        } else {
                            console.log('something else other than 200 was returned')
                            console.log(xmlhttp.responseText)
                        }
                    }
                } // end-xmlhttp.onreadystatechange()
                xmlhttp.open('POST', url, false)
                xmlhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded')
                xmlhttp.send(data)
            } // end-requestData()

            // 清空地图
            var clearMap = function () {
                // 地图上台风数量的计数器
                typhoonCount = 0
                // 台风信息气泡
                infoWindow.close()
                // 路径折线数组
                for (var j = 0; j < polylineArray.length; j++) {
                    polylineArray[j].setMap(null)
                    polylineArray[j] = null
                }
                polylineArray = []
                // 台风路径点的点击事件数组
                for (var i = 0; i < markerEventArray.length; i++) {
                    qq.maps.event.removeListener(markerEventArray[i])
                    markerEventArray[i] = null
                }
                markerEventArray = []
                // 台风路径集合
                markerCluster.clearMarkers()
                // 台风数据数组
                typhoonList = []
                typhoonListSnd = []
                typhoonListTrd = []
            }

            // 页面加载时向服务器请求起始数据
            var startupRequest = function () {
                var year = new Date().getFullYear()
                var url = 'http://123.234.129.238:8001/MyWebService.asmx/GetTyphoonList'
                var data = 'areaflg=山东&Typhoonyear=' + year
                var res = []
                var xmlhttp = new XMLHttpRequest()
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState === XMLHttpRequest.DONE) {   // XMLHttpRequest.DONE === 4
                        if (xmlhttp.status === 200) {
                            // console.log(xmlhttp.responseText)
                            var parser = new DOMParser()
                            var xmldoc = parser.parseFromString(xmlhttp.responseText, 'text/xml')
                            // console.log(JSON.parse(xmldoc.getElementsByTagName('string')[0].innerHTML))
                            var divarr = xmldoc.getElementsByTagName('string')
                            // 获取列表
                            for (var i = 0; i < divarr.length; i++) {
                                res.push(divarr[i].innerHTML)
                            }
                            // 大于3?
                            if (res.length >= 3) {
                                for (var j = 0; j < 3; j++) {
                                    /* 切割字符串 */
                                    var resarr = res[res.length - 1 - j].split(',')
                                    requestTyphoonPath(resarr[1], resarr[0], false)
                                }
                            } else {
                                for (var k = res.length - 1; k > 0; k--) {
                                    /* 切割字符串 */
                                    var resarr = res[k].split(',')
                                    requestTyphoonPath(resarr[1], resarr[0], false)
                                }
                            }
                        } else if (xmlhttp.status === 400) {
                            console.log('error 400')
                            alert('There was an error 400')
                        } else {
                            console.log('something else other than 200 was returned')
                            console.log(xmlhttp.responseText)
                        }
                    }
                } // end-xmlhttp.onreadystatechange()
                xmlhttp.open('POST', url, true)
                xmlhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded')
                xmlhttp.send(data)
            } // end-startupRequest

            // 向服务器请求台风路径
            var requestTyphoonPath = function (typhoonName, typhoonNo, alwaysshow) {
                var url = 'http://123.234.129.238:8001/MyWebService.asmx/GetTyphoonPath'
                var data = 'areaflg=青岛&typhoonNumber=' + typhoonNo
                var res = []
                var active = false
                var xmlhttp = new XMLHttpRequest()
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState === XMLHttpRequest.DONE) {   // XMLHttpRequest.DONE === 4
                        if (xmlhttp.status === 200) {
                            // console.log(xmlhttp.responseText)
                            var parser = new DOMParser()
                            var xmldoc = parser.parseFromString(xmlhttp.responseText, 'text/xml')
                            /* 切割字符串 */
                            var bigarr = xmldoc.getElementsByTagName('string')[0].innerHTML.split('#$')
                            // 最后一个项为空项
                            for (var i = 0; i < bigarr.length - 1; i++) {
                                /* 切割字符串 */
                                var smallarr = bigarr[i].split(',')
                                var info = {
                                    name: typhoonName,              // 台风名称
                                    number: typhoonNo,              // 台风编号
                                    date: smallarr[0],              // 数据日期
                                    longitude: smallarr[1],         // 经度
                                    latitude: smallarr[2],          // 纬度
                                    centerpressure: smallarr[3],    // 中心气压
                                    centerspeed: smallarr[4],       // 中心风速
                                    sevencircle: smallarr[5],       // 七级风圈
                                    tencircle: smallarr[6],         // 十级风圈
                                    movingspeed: smallarr[7],       // 移动速度
                                    movingdir: smallarr[8]          // 移动方向
                                }
                                res.push(info)
                            } // end-for
                            // 获得数据列表
                            // console.log(res)
                            // 判断时效性
                            var today = new Date()
                            today = today.setHours(today.getHours() - 10)
                            tydate = new Date(res[res.length - 1].date)
                            if (tydate < today) {
                                console.log('typhoon ' + typhoonNo + ' has finished.')
                                active = false
                            } else {
                                active = true
                            }
                            // 如果不是强制显示且该台风已过期 则跳过该台风
                            if (alwaysshow === false & active === false) {
                                return
                            }
                            // 查看哪个数组为空
                            var count = 0   // 本地的台风计数器
                            switch (typhoonCount) {
                                case 0:
                                    typhoonCount++
                                    count = 1
                                    typhoonList = res
                                    break
                                case 1:
                                    typhoonCount++
                                    count = 2
                                    typhoonListSnd = res
                                    break
                                case 2:
                                    typhoonCount++
                                    count = 3
                                    typhoonListTrd = res
                                    break
                                default:
                                    break
                            } // end-switch
                            // 在地图上显示该台风
                            addTyphoonToMap(res)
                            // 如果台风是活动状态则请求预测路线
                            if (active === true) {
                                requestPathPrediction(typhoonName, typhoonNo, '中国', res[res.length - 1])
                                requestPathPrediction(typhoonName, typhoonNo, '中国台湾', res[res.length - 1])
                                requestPathPrediction(typhoonName, typhoonNo, '中国香港', res[res.length - 1])
                                requestPathPrediction(typhoonName, typhoonNo, '美国', res[res.length - 1])
                                requestPathPrediction(typhoonName, typhoonNo, '日本', res[res.length - 1])
                                requestPathPrediction(typhoonName, typhoonNo, '韩国', res[res.length - 1])
                            }
                        } else if (xmlhttp.status === 400) {
                            console.log('error 400')
                            alert('There was an error 400')
                        } else {
                            console.log('something else other than 200 was returned')
                            console.log(xmlhttp.responseText)
                        }
                    }
                } // end-xmlhttp.onreadystatechange()
                xmlhttp.open('POST', url, true)
                xmlhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded')
                xmlhttp.send(data)
            } // end-requestTyphoonPath()

            // 向服务器请求台风路径预测
            var requestPathPrediction = function (typhoonName, typhoonNo, forecastsite, lastpoint) {
                var url = 'http://123.234.129.238:8001/MyWebService.asmx/Typhoonforcastpath'
                var data = 'name=admin&areaflg=青岛&number=' + typhoonNo + '&forcastlestTyphoon=' + forecastsite
                var res = []
                var xmlhttp = new XMLHttpRequest()
                xmlhttp.onreadystatechange = function () {
                    if (xmlhttp.readyState === XMLHttpRequest.DONE) {   // XMLHttpRequest.DONE === 4
                        if (xmlhttp.status === 200) {
                            // console.log(xmlhttp.responseText)
                            var parser = new DOMParser()
                            var xmldoc = parser.parseFromString(xmlhttp.responseText, 'text/xml')
                            // console.log(forecastsite)
                            // console.log(xmldoc.getElementsByTagName('string')[0].innerHTML)
                            // 返回值为'当前无台风'时 直接返回
                            var resstring = xmldoc.getElementsByTagName('string')[0].innerHTML
                            if (resstring === '当前无台风') {
                                return
                            }
                            var bigarr = resstring.split('#$')
                            // 最后一项为空
                            for (var i = 0; i < bigarr.length - 1; i++) {
                                var smallarr = bigarr[i].split(',')
                                var info = {
                                    name: typhoonName,
                                    number: typhoonNo,
                                    site: forecastsite,
                                    date: smallarr[0],
                                    longitude: smallarr[1],
                                    latitude: smallarr[2],
                                    centerpressure: smallarr[3] == '' ? '-' : smallarr[3],
                                    centerspeed: smallarr[4] == '' ? '-' : smallarr[4]
                                }
                                res.push(info)
                            } // end-for
                            // 将预测数据载入地图
                            addPredicToMap(res, lastpoint)
                        } else if (xmlhttp.status === 400) {
                            console.log('error 400')
                            alert('There was an error 400')
                        } else {
                            console.log('something else other than 200 was returned')
                            console.log(xmlhttp.responseText)
                        }
                    }
                } // end-xmlhttp.onreadystatechange()
                xmlhttp.open('POST', url, true)
                xmlhttp.setRequestHeader('Content-type', 'application/x-www-form-urlencoded')
                xmlhttp.send(data)
            }

            // 根据中心风力大小获取对应的台风级别和icon路径
            var getTyphoonLevel = function (centerspeed) {
                if (centerspeed < 17.2) {
                    return ['热带低压', 'TropicalDepression.png']
                } else if (centerspeed < 24.5) {
                    return ['热带风暴', 'tropicalStorm.png']
                } else if (centerspeed < 32.6) {
                    return ['强热带风暴', 'SevereTropicalStorm.png']
                } else if (centerspeed < 41.4) {
                    return ['台风', 'Typhoon.png']
                } else if (centerspeed < 50.9) {
                    return ['强台风', 'ViolentTyphoon.png']
                } else {
                    return ['超强台风', 'SuperTyphoon.png']
                }
            } // end-getTyphoonLevel()

            // 根据一个标记点信息生成Marker和Listener
            var typhoonInfoToMarkerListner = function (info) {
                // Marker
                var newmarker = new qq.maps.Marker({
                    position: new qq.maps.LatLng(info.latitude, info.longitude),
                    map: map
                })
                var newicon = new qq.maps.MarkerImage(
                    './Images/' + getTyphoonLevel(info.centerspeed)[1],
                    new qq.maps.Size(11, 11),  // size
                    new qq.maps.Point(0, 0),    // origin
                    new qq.maps.Point(6, 6),   // anchor
                    new qq.maps.Size(11, 11)    // scaleSize
                )
                newmarker.setIcon(newicon)
                // Listener
                var newlistener = new qq.maps.event.addListener(newmarker, 'click', function () {
                    // TODO: 填充并显示InfoWindow
                    infoWindow.setContent('<div style=\'padding:0px 0px 0px 4px;\'><b>台风信息：' + info.name + '</b><br/>'
                        + '时间：' + info.date + '<br/>'
                        + '经纬度：' + info.longitude + '°E, ' + info.latitude + '°N' + '<br/>'
                        + '中心气压(百帕)：' + info.centerpressure + '<br/>'
                        + '中心风力(米/秒)：' + info.centerspeed + '<br/>'
                        + '七级风圈(公里)：' + info.sevencircle + '<br/>'
                        + '十级风圈(公里)：' + info.tencircle + '<br/>'
                        + '移动速度(公里/时)：' + info.movingspeed + '<br/>'
                        + '移动方向：' + info.movingdir
                        + '</div>')
                    infoWindow.setPosition(newmarker)
                    infoWindow.open()
                }) // end-new listener
                markerCluster.addMarker(newmarker)
                markerEventArray.push(newlistener)
            } // end-typhoonInfoToMarker()

            // 根据路径点在地图上显示折线
            var pathToPolyline = function (path, linestyle, linecolor) {
                var newline = new qq.maps.Polyline({
                    clickable: false,
                    map: map,
                    path: path,
                    strokeColor: linecolor,
                    strokeDashStyle: linestyle,
                    zIndex: 5
                })
                polylineArray.push(newline)
            } // end-pathToPolyline()

            // 由路径和最后一个点的信息生成移动Marker
            var typhoonInfoToMovingMarker = function (lastinfo, path) {
                // Marker
                var newmarker = new qq.maps.Marker({
                    position: path[0],
                    map: map,
                    zIndex: 10
                })
                var newicon = new qq.maps.MarkerImage(
                    './Images/tf_center25x25.gif',
                    new qq.maps.Size(29, 29),  // size
                    new qq.maps.Point(0, 0),    // origin
                    new qq.maps.Point(15, 15),   // anchor
                    new qq.maps.Size(29, 29)    // scaleSize
                )
                newmarker.setIcon(newicon)
                // Listener
                // 弹出信息框
                var newlistener = new qq.maps.event.addListener(newmarker, 'click', function () {
                    infoWindow.setContent('<div style=\'padding:0px 0px 0px 4px;\'><b>台风信息：' + lastinfo.name + '</b><br/>'
                        + '时间：' + lastinfo.date + '<br/>'
                        + '经纬度：' + lastinfo.longitude + '°E, ' + lastinfo.latitude + '°N' + '<br/>'
                        + '中心气压(百帕)：' + lastinfo.centerpressure + '<br/>'
                        + '中心风力(米/秒)：' + lastinfo.centerspeed + '<br/>'
                        + '七级风圈(公里)：' + lastinfo.sevencircle + '<br/>'
                        + '十级风圈(公里)：' + lastinfo.tencircle + '<br/>'
                        + '移动速度(公里/时)：' + lastinfo.movingspeed + '<br/>'
                        + '移动方向：' + lastinfo.movingdir
                        + '</div>')
                    infoWindow.setPosition(newmarker)
                    infoWindow.open()
                }) // end-new listener
                // 移动结束后重定位marker
                var movinglistener = new qq.maps.event.addListener(newmarker, 'moveend', function () {
                    newmarker.setPosition(path[path.length - 1])
                })
                markerCluster.addMarker(newmarker)
                markerEventArray.push(newlistener)
                markerEventArray.push(movinglistener)
                // 移动路径
                newmarker.moveAlong(path, 400000)
            } // end-typhoonInfoToMovingMarker()

            // 将整组台风数据显示在地图上
            var addTyphoonToMap = function (infoarray) {
                // Marker Listener Polyline Moving-Marker
                var path = []
                for (var i = 0; i < infoarray.length; i++) {
                    // Marker Listener
                    typhoonInfoToMarkerListner(infoarray[i])
                    path.push(new qq.maps.LatLng(infoarray[i].latitude, infoarray[i].longitude))
                } // end-for
                // Polyline
                pathToPolyline(path, 'solid', '#3366FF')
                // Moving-Marker
                typhoonInfoToMovingMarker(infoarray[infoarray.length - 1], path)
            } // end-addTyphoonToMap()

            // 将整组预测线路数据显示在地图上
            var addPredicToMap = function (infoarray, lastpoint) {
                // Marker Listener Polyline
                var path = []
                path.push(new qq.maps.LatLng(lastpoint.latitude, lastpoint.longitude))
                for (var i = 0; i < infoarray.length; i++) {
                    predicInfoToMarkerListener(infoarray[i])
                    path.push(new qq.maps.LatLng(infoarray[i].latitude, infoarray[i].longitude))
                }
                // Polyline
                pathToPolyline(path, 'dash', getPredicLineColor(infoarray[0].site))
            } // end-addPredicToMap()

            // 根据预测点信息生成Marker和Listener
            var predicInfoToMarkerListener = function (info) {
                // Marker
                var newmarker = new qq.maps.Marker({
                    position: new qq.maps.LatLng(info.latitude, info.longitude),
                    map: map
                })
                var newicon = new qq.maps.MarkerImage(
                    './Images/' + getTyphoonLevel(info.centerspeed)[1],
                    new qq.maps.Size(11, 11),  // size
                    new qq.maps.Point(0, 0),    // origin
                    new qq.maps.Point(6, 6),   // anchor
                    new qq.maps.Size(11, 11)    // scaleSize
                )
                newmarker.setIcon(newicon)
                // Listener
                var newlistener = new qq.maps.event.addListener(newmarker, 'click', function () {
                    // TODO: 填充并显示InfoWindow
                    infoWindow.setContent('<div style=\'padding:0px 0px 0px 4px;\'><b>台风信息：' + info.name + '</b><br/>'
                        + '时间：' + info.date + '<br/>'
                        + '经纬度：' + info.longitude + '°E, ' + info.latitude + '°N' + '<br/>'
                        + '中心气压(百帕)：' + info.centerpressure + '<br/>'
                        + '中心风力(米/秒)：' + info.centerspeed
                        + '</div>')
                    infoWindow.setPosition(newmarker)
                    infoWindow.open()
                }) // end-new listener
                markerCluster.addMarker(newmarker)
                markerEventArray.push(newlistener)
            } // end-predicInfoToMarkerListener

            // 根据国家返回预测线颜色代码
            var getPredicLineColor = function (country) {
                switch (country) {
                    case '中国':
                        return '#F53C49'
                    case '美国':
                        return '#44D9F5'
                    case '日本':
                        return '#5BF964'
                    case '韩国':
                        return '#5e9492'
                    case '中国香港':
                        return '#FF982E'
                    case '中国台湾':
                        return '#EA6AE9'
                    default:
                        return '#000000'
                }
            } // end-getPredicLineColor

        })()
    </script>

</body>

</html>